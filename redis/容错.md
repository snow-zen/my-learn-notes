# 容错
#Redis 

Redis 集群通过 ping 和 pong 数据包来交换重要的配置信息，两种报文的结构是相同的，唯一的区别是消息类型。我们将 ping 和 pong 统称为**心跳数据包**。

通常情况下发送方节点发送 ping 包，接收方节点发送 pong 包。当然，这不是固定的模式，发送方也可以直接发送 pong 包以快速向其他节点传播重要配置信息，而接受方也不会响应信息。

通常节点每秒会向随机节点发送 ping 包，发送节点数是固定常量，与集群中的节点数无关。节点在发送 ping 包后，如果超过 `NODE_TIME` 一半的时间未响应，则会重新发送 ping 包。如果到达 `NODE_TIME` 时间之前还未响应，则节点会尝试将 TCP 连接到另一个节点，以排除网络通信问题。

> 注意：NODE_TIME 时间一定要大于网络往返时间，防止出现无效的重试。

## 心跳包内容

ping 和 pong 数据包包含一个对所有类型都通用的标头，以及一个特定于 ping 和 pong 包的特殊 gossip 部分。

公共标头具有以下信息：

+ 节点 ID，一个 160 位伪随机字符串，在创建节点时分配，并在整个集群生命周期内保持不变。
+ 发送节点的 `currentEpoch` 和 `configEpoch` 字段。如果节点是副本节点，则 `configEpoch` 是其主节点最后一个已知 `configEpoch`。
+ 节点标识，标识节点是否副本、主节点和其他信息。
+ 发送节点提供的哈希槽位图。如果节点是副本节点，则提供的是其主节点的哈希槽位图。
+ 发送方用于接受客户端命令的 TCP 端口。
+ 发送方用于集群通信的 TCP 端口。
+ 发送方角度下集群的状态（ok 或 down）。
+ 发送方主节点的 ID（如果节点是副本）。

特殊的 gossip 部分仅包含已知一组节点中几个随机节点的信息。gossip 部分提到的节点数量与集群大小成正比。对于 gossip 部分添加的节点都具有以下字段：

+ 节点 ID。
+ 节点的 IP 和端口。
+ 节点标志。



