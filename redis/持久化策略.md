# 持久化策略
#Redis 

Redis 支持将数据持续写入到磁盘中，已确保键不会丢失。它有两种选项：

## RDB

以指定的时间间隔对数据集生成快照。例如，当 60 秒内更改了 1000 个键时则生成快照：

```conf
save 60 1000
```

### 优点

+ RDB 是一种数据结构非常紧凑的单文件，非常适合备份数据。
+ RDB 非常适合灾难恢复，也是一个可以传输到远程数据中心的压缩文件。
+ RDB 可以最大程度提高 Redis 的性能，因为 Redis 父进程为了持久化唯一需要做的工作就是派生子进程去完成其余工作，父进程永远不会执行类似磁盘 I/O 操作。
+ 与 AOF 相比，在大数据集的情况下能够更快恢复。

## 缺点

+ RDB 保存时间的时间间隔较长。因此，如果 Redis 突然宕机，它可能会丢失分钟级别的数据。
+ RDB 需要经常 fork 子进程在磁盘工作，数据集越大，fork 的时间就会更长。当数据集大且 CPU 性能不是很好的情况下，会导致 Redis 停止服务客户端几毫秒甚至是一秒。

## AOF

将 Redis 实例接收到的写操作命令追加到持久化日志文件中。在服务器启动时，可重新执行命令达到恢复数据的效果。当日志文件变得太大时，Redis 可在后台重写日志文件。

AOF 持久化策略需要在配置文件中开启：

```conf
appendonly yes
```

fsync 策略有三种选项：

+ `appendfsync always`：每次都将新命令追加到 AOF 文件中。
+ `appendfsync everysec`：每秒讲新命令追加到 AOF 文件中。
+ `appendfsync no`：不进行追加操作。

## 优点

+ AOF 让 Redis 变的更加耐用，可以使用不同的 fsync 同步策略。fsync 是使用后台线程同步的，因此即使在 fsync 线程没在工作时，最多只会丢失一秒的数据。
+ AOF 是一个仅附加的日志，因此它不会有磁盘寻道的问题。即使以某种原因日志写到一半就结束，也可以使用 redis-check-aof 工具修复。
+ 当 AOF 文件太大时，Redis 可以在后台自动重写 AOF 文件。重写是完全安全的，因为重写过程中还是追加到旧的文件中，一旦新的 AOF 文件重写完成，则立刻切换到新的AOF 文件中。
+ AOF 内部的日志操作都是可读的，你可以对其进行修改。

## 缺点

+ 在相同的数据集下，AOF 文件比 RDB 文件大。
+ AOF 可能比 RDB 要慢，这取决于确切的 fsync 策略。
+ 在重写期间，如果有对数据的写入操作，则会消耗额外的内存缓冲命令。这些缓冲命令会在新 AOF 重写完成后全部写入。
+ 重写期间，所有的写入命令都会写入磁盘两次。
+ Redis 重写完成后会冻结写入并将这些写入同步到新 AOF 文件中。