# 搬移函数
#Refactoring 

模块化是优秀软件的核心，好的模块化能够让我在修改程序时只需理解程序的一小部分。

## 动机

为了设计出高度模块化的程序，得保证互相关联的软件要素都能集中到一块，并确保块与块之间的联系易于查找、直观易懂。

> 模块设计的理解并不是一成不变的，它会随着对代码的理解加深，而进行不断的调整。

任何函数都需要具备上下文环境才能存活。这个上下文可以是全局的，但更多时候是由某种形式的模块所提供的。

搬移函数最直接的一个动因是，它频繁引用其他上下文中的元素，而对自身所在上下文的元素却关心甚少。因此，让其去那些更亲密的模块时，通常会有更好的封装效果，并且可以减少系统别处对当前模块的依赖。

同理，在整理代码时，发现需要频繁调用的一个别处函数时，也会考虑搬移该函数。有时可能在函数内部定义一个帮助函数，而该函数可能在别的地方有用到，此时可以搬移到更加通用的地方。

为函数选择一个好的去处不容易，通常最好的做法是先将函数安置到某一个上下文里去，这样可以发现它们是否契合，如果不太合适可以再把函数搬移到别的地方。

## 做法

1. 检查函数在当前上下文里引用的所有程序元素（包括变量和函数），考虑是否需要将它们一并搬移。

> 如果发现有些被调用的函数也需要搬移，我通常会先搬移它们。这样可以保证移动一组函数时，总是从依赖最少的那个函数入手。
> 如果该函数拥有一些子函数，并且是子函数的唯一调用者，那么可以先将子函数内联进来，一并搬移到新家后重新提炼子函数。

2. 检查待搬移函数是否具有多态性。

> 面向对象语言中，还需要考虑该函数是否覆写超类的函数，或者为子类所覆写。

3. 将函数复制一份到目标上下文中。调整函数，使它可以适应新家。

> 如果函数里用到源上下文中的元素，就得将这些元素一并传递过去，要么通过函数参数，要么是讲当前上下文的引用传递到新的上下文那么去。通常意味着，还得给它起个新名字使其符合新上下文。

4. 执行静态检查。
5. 设法从源上下文中正确引用目标函数。
6. 修改源函数，使之成为一个纯委托函数。
7. 测试。
8. 考虑对源函数使用[[内联函数]]。

> 也可不必内联，让源函数一直做委托调用。但如果调用方直接调用目标函数也不费太多周折，则最好把中间人移除掉。