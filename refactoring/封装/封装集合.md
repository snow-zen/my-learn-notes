# 封装集合
#Refactoring 

封装程序中所有的可变数据，可以更容易定位被修改的地点和修复方式。

## 动机

通常是鼓励封装的，但是封装集合时常常犯一个错误：只对集合变量的访问进行封装，但依然让取值函数返回集合本身。使得集合的成员变量可以直接被修改，而封装它的类则全然不知，无法介入。

为了避免这种情况，可以在类上提供修改集合的方法，或者不要让集合的取值函数返回原始集合，这样就避免了客户端的意味修改。

还有一种方式是，以某种形式限制集合的访问权，只允许对集合进行读操作。例如，Java 中可以返回集合的一个只读代理。

另一种最常见的做法是，为集合提供一个取值函数，但令其返回一个集合的副本。但如果集合很大，这个做法可能带来性能问题，好在多数列表没有那么大。

## 做法

1. 如果集合上的引用尚未被封装起来，先用[[封装变量]]封住它。
2. 在类上添加用于“添加集合元素”和“移除集合元素”的元素。

> 如果存在对该集合的设值函数，尽可能先用[[移除设值函数]]移除它。如果不能移除该设值函数，至少让它返回集合的一份副本。

3. 执行静态检查。
4. 查找集合的引用点。如果有调用者直接修改集合，令该处调用使用新的添加 / 移除元素的函数。每次修改后执行测试。
5. 修改集合的取值函数，使其返回一份只读的数据，可以使用只读代理或数据副本。
6. 测试。