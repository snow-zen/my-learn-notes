# 以查询取代派生变量
#Refactoring 

可变数据是软件中最大的错误源头之一。

## 动机

对数据的修改常常导致代码的各个部分以丑陋的形式互相耦合：在一处修改数据，却在另一处造成难以发现的破坏。

> 尽管完全去掉可变数据并不现实，但还是强烈建议：尽量把可变数据的作用域限制在最小范围。

有些变量其实可以很容易计算出来。如果可以去掉这些变量，也算朝着消除可变性的方向迈出一大步。计算常能清晰地表达数据的含义，而且避免了“数据修改时忘记更新派生变量”的错误。

但是有种例外情况：如果计算的源数据是不变的，并且我们可以强制要求计算的结果也是不可变的，那么就不必重构消除计算得到的派生变量。这种情况下重构与否只是两种编程风格的差异。

## 做法

1. 识别出所有对变量做更新的地方。如果有必要，用[[拆分变量]]分割各个更新点。
2. 新建一个函数，用于计算该变量的值。
3. 用[[引入断言]]断言该变量和计算函数始终给出同样的值。

> 如有必要，用[[封装变量]]将这个断言封装起来。

4. 测试。
5. 修改读取该变量的代码，令其调用新建的函数。
6. 测试。
7. 用[[移除死代码]]去掉变量的声明和赋值。