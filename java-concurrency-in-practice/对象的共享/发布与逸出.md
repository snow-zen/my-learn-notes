# 发布与逸出
#Java #Multithreading 

**发布**是指使对象能够在当前作用域之外的代码中使用。许多情况中，我们要确保对象及其内部状态不被发布。而在某些情况下，我们又需要发布某个对象，但如果在发布时要确保线程安全性，则可能需要同步。而当某个不该发布的对象被发布时，就被称为**逸出**。

> 注意：发布内部状态可能会破坏封装性，并使得程序无法维持不可变性条件。例如：对象构造完成之前就发布该对象，就会破坏线程安全性。

例如，发布一个私有属性：

```java
public class UnsafeStates {
    
    private String[] states = new String[] {
            "AK", "AL"
    };
    
    public String[] getStates() {
        return states;
    }
}
```

当例子中的 states 属性被发布时，数值 states 就已经逸出它所在的作用域，因为本该是私有的属性被发布，此时任何调用者都可以修改数组内的内容。

> 当发布一个对象时，在该对象的非私有域中引用的所有对象同样也会被发布。

当把一个对象传递给某个外部方法时，就相当于发布对象。而你无法知道外部代码如何使用该对象。因此当某个对象逸出后，必须假设有某个类或线程可能误用该对象。使用封装的最主要原因：封装能够使得对程序的正确性进行分析变得可能，并使得无意中破坏设计约束条件变得更难。

## 安全对象的构造过程

当且仅当对象的构造函数返回时，对象才处于可预测和一致性的状态。因此，当从对象的构造函数中发布对象时，只是发布了一个尚未构造完成的对象。即使发布对象的语句位于构造函数的最后一行也是如此。

> 在构造过程中 this 引用逸出，那么这种对象就被认为是不正确的。

构造过程中使 this 引用逸出的另一种常见错误是，在构造函数中创建一个线程，this 引用都会被新创建的线程共享。在对象尚未完全构造之前，新线程就可以看见它。在构造函数中创建线程并没有错误，但最好不要立即启动它，而是通过一个 start 或 initialize 方法启动。