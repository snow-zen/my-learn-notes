# 集群水平扩展
#Redis 

Redis 可通过集群的方式水平扩展。

## TCP 端口

集群中的每个节点都需要开放两个 TCP 端口：一个是为客户端提供服务的 6379 端口，另外一个是集群总线的通信端口。默认情况下，为第一个端口加 10000，例如 16379。同时，也可以通过 `cluster-port` 配置覆盖它。

第二个集群通信端口，使用二进制协议的节点到节点通信通道。每个节点使用集群通信端口完成故障检测、配置更新、故障转移等。

对于两个通信端口需要保证以下两点：

1. 与客户端通信的 6379 端口需要对所有客户端以及其他集群节点开发。
2. 集群总线端口需要对所有其他集群节点开发。

集群总线使用不同的二进制协议进行节点到节点之间的数据交换，它更适合使用很少带宽和处理时间在节点之间交换信息。

## 数据分片

集群使用哈希分片将数据分为多个槽，其中每个键都是哈希槽的一部分。

Redis 集群有 16384 个哈希槽，对于任意一个键要计算它的哈希槽，只需通过 $CRC16(key) \% 16384$ 即可获得对应的哈希槽。

虽然 CRC16 算法可以分配 65536（$2^{16}$）个槽位，即使通过 bitmap 进行压缩所占空间也达到了 8K。作者考虑到 Redis 集群的最大基本不可能超过 1000 个主节点，且每次通信时发送的心跳包过大容易浪费带宽，因此将槽位设置为 16384，经过 bitmap 压缩后为 2k。在保证每个主节点可以分配到足够槽位的同时，降低心跳包的大小。

> 简而言之，这是心跳消息大小和主实例持有的平均槽位之间的平衡结果。

对于已经在运行的 Redis 集群如果添加或删除节点时，可在不停机的情况下重新分配槽位。删除节点时，需要在移除它所持有的槽位后才能删除。

集群可以支持多键操作，但是有个限制条件：单个命令所涉及的键都属于同一个哈希槽内。用户可以通过设置哈希标签的方式将多个键放在同一个哈希槽内。

## 主从模型

Redis 集群采用主从模型，目的在于当一部分主节点发生故障或无法与大多数节点通信的时候保持可用。

主从模型中每个哈希槽具有一个主节点和 N 个副本节点。主节点负责提供客户端对自身所持有哈希槽的服务，而副本节点则通过[[复制]]机制备份主节点所持有哈希槽的数据和命令。

当主节点不可用时，如果主节点有关联的副本节点，则副本节点提升为主节点并接替工作。如果主节点没有关联的副本节点则集群无法工作。

## 强一致性

Redis 集群并不保证强一致性。实际上某些情况下，Redis 集群可能会丢失系统向客户端确认的写入。

原因 1：主实例确认请求数据后，异步复制完成前，主实例不可用。副本提升为新主实例后，数据永远失去了。

原因 2：由于网络分区原因，一主实例与其他主实例和副本之间隔离，但还可以与客户端通信，如果在节点超时时间后还没有连接到大多数节点，则进入错误状态并停止写入数据。

> 节点超时是 Redis 集群的一个非常重要的配置，可以用于主实例不可用达到指定时间后进行副本实例提升，也可用于主实例被分区后无法连接大多数其他主实例时，主动进入错误状态并停止接收写入。