# 不变性
#Java #Multithreading 

满足同步需求的另一种方式就是[[可变性最小化|不可变对象]]。目前遇到的许多原子性和可见性的问题都与多线程访问同一个可变的状态有关，如果对象的状态不可改变那么问题自然也就消失了。

如果某个对象创建之后不能被修改，这个对象就称为不可变对象。线程安全性是不可变对象的固有属性之一，它们的不变性是由构造函数创建的，只要它们的状态不改变，那么这些不变性条件就能得以维持。

> 不可变对象一定是线程安全的。

不可变对象存在以下特点：简单、安全和高效。

**简单**

不可变对象很简单，它只有一种状态，并且该状态由构造函数来控制。而程序设计时最复杂的地方在于判断复杂对象的可能状态。然而，判断不可变对象却很简单。

**安全**

如果将一个可变对象传递给不可信的代码，或者将对象发布到不可信代码可以访问到的地方。那么不可信代码就可以改变它的状态，更糟糕的是保存对象的引用并稍后通过其他线程修改对象的状态。不可变对象不会像这样被恶意代码或者有问题的代码破坏，因此可以安全的共享和发布而无需创建[[必要时进行保护性拷贝|保护性副本]]。

**高效**

不可变对象减少了加锁和保护性副本的需求，以及降低了对基于”代“的垃圾回收机制的影响。

## 不可变性定义

当满足以下条件时，对象才是不可变的：

+ 对象创建以后其状态就不能改变。
+ 对象的所有域都是final类型。
+ 对象是正确创建的（在创建对象期间，this 引用没有逸出）。

## Final 属性

在 Java 中关键字 final 用于构造不可变对象，final 类型的域是不可变的。

在 Java 内存模型中，final 域还能确保初始化过程的安全性，从而可以不受限制地访问不可变对象，并在共享这些对象时无需同步。

另外即使对象是可变的，我们也可以通过将对象的某些域声明为 final 类型以限制对象的可变性。而限制对象的可变性就是限制对象可能状态的集合。仅包含一个或两个状态的对象的“基本不可变对象”要比多个状态的对象简单，后期也更好维护。

> 除非需要某个域是可变的，否则应将其声明为 final 域。