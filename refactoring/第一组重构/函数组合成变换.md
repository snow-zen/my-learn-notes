# 函数组合成变换
#Refactoring 

软件中，经常需要把数据“喂”给一个程序，让它再计算出各种派生信息。

## 动机

计算的派生信息可能在多个不同的地方用到，因此这些计算逻辑也常会在用到派生数据的地方重复计算。因此，将所有计算派生数据的逻辑收拢到一处，这样始终可以在固定的地方找到和更新这些逻辑，避免到处重复。

一种方式是数据变换函数：这种函数接收源数据作为输入，计算出所有派生数据，将派生数据以字段形式填入输出数据。这种方式只需要检查变换函数中生成派生数据的逻辑。

另一种方式是[[函数组合成类]]，后者采用的是先用源数据组合成一个类，再把相关的计算逻辑搬移到类中。

两种重构手法都有用，但两者有个重要的区别：如果源数据发生更新，那么使用类要好很多；如果使用变换，派生数据会存储在新生成的记录中，一旦源数据被修改，就会遭遇数据不一致。

## 做法

1. 创建一个变换函数，输入参数是需要变换的记录，并直接返回记录的值。

> 这一步通常需要对输入记录做深复制。此时应该写个测试，确保变换不会修改原来的记录。

2. 挑选一块逻辑，将其主题移入变换函数中，把结果作为字段添加到记录中。修改客户端代码，令其使用这个新字段。

> 如果计算逻辑比较复杂，先用[[提炼函数]]提炼。

3. 测试。
4. 针对其他相关的计算逻辑，重复上述步骤。