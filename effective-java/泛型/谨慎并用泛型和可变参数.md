# 谨慎并用泛型和可变参数
#Java 

泛型和可变参数都是在 Java 5 中引入的，但是它们并不能良好的相互作用。

可变参数的作用在于让客户端能够将可变数量的参数传给方法，但这是个**技术露底**：当调用一个可变参数方法时，会创建一个数组用来保存可变参数；这个数组应该是一个实现细节，它是可见的。因此，当可变参数有泛型或者参数化类型时，编译器警告就会产生混乱。

由于非具体化类型是指其运行时代码信息比编译时少。如果一个方法声明其可变参数为非具体化类型，或者在非具体化可变参数上操作时，编译器都会产生警告。并且当一个参数化类型变量指向一个不是该类型的对象时，会产生堆污染。

因此，将值保存在泛型可变参数数组参数中是不安全的。

## 并用的矛盾

虽然泛型和可变参数之间存在这一矛盾，但实际带有泛型可变参数或者参数化类型的方法在实践中的用处很大，因此 Java 语言的设计者才能容忍这个问题的存在。

在 Java 7 之前，带泛型可变参数的设计者，对于调用处的警告是没有办法的。用户必须忍受警告或者使用 `@SuppressWarnings("unchecked")` 注解消除警告。这么做过于烦琐，而且影响可读性，并且掩盖反映实际问题的警告。

在 Java 7 中，增加 SafeVarargs 注解，它让带泛型 vararg 参数方法的设计者能够自动禁止客户端的警告。本质上，该注解是通过方法的设计者做出承诺，声明这是类型安全的。作为对于承诺的交换，编译器同意不再向该方法的用户发出警告说这些调用可能不安全。

## SafeVarargs 注解使用

更重要的是，不要随意在方法上使用 SafeVarargs 注解，除非它是真的安全。而对于泛型可变参数在下列条件下才是安全的：
1. 没有在可变参数数组中保存任何值，只做读取。
2. 没有对不信任的代码发布数组或者克隆数组。

对于每个带有泛型可变参数或者参数化类型的方法，都要用 @SafeVarargs 进行注解。这意味着应该永远不要编写不安全的可变参数方法。每当编译器警告你控制的某个带泛型可变参数方法可能形成堆污染，就应该检查该方法是否安全。

> ⚠️ 注意：SafeVarargs 注解只能用在无法被覆盖的方法上，因为它无法保证可能覆盖的方法都是安全的。Java 8 中，注解只在静态方法和 final 方法中才是合法的；在 Java 9 中，私有方法也是合法的。

如果不想使用 SafeVarargs 注解，则可以使用列表来代替可变参数，这种做法优势在于编译器可以证明方法是类型安全的，但缺点是客户端代码有点繁琐，运行起来速度也更慢一些。