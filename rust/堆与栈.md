# 堆与栈
#Rust 

在其他语言中，你无需考虑值是分配到堆还是栈中。不过在 Rust 中，值是在栈上还是堆上在更大程度上影响了语言的行为以及为何做出这样的抉择。

> 栈和堆都是代码在运行时使用的内存区域，但是它们的结构不同。

栈存取值遵循**后进先出**的顺序，增加数据叫做**入栈**，移除数据叫做**出栈**。栈上所有的数据都必须是已知固定大小的，如果编译期间无法确定大小或大小可能变化的数据，则需要改为存在在堆上。

堆是缺乏组织的，数据的存取没有顺序。当向堆存放数据时，需要请求一定大小的空间，内存分配器在堆的某处找到足够大小的空间标记为 “已使用”，并返回一个表示该位置地址的**指针**。整个过程称为 “分配”。

> 堆上数据的指针是固定大小的，因此它可以存储在栈上。当需要访问数据时，可通过存储在栈上的指针间接访问指针指向的存储在堆上的数据。

入栈比在堆上分配数据要快，因为入栈无需像堆一样要求查找足够的空间，而且入栈的数据对应位置总是在栈顶。相比之下，堆上分配内存则需要更多的工作，堆上内存分配器首先必须找到一块足够的内存区域，并接着做一些记录为下一次分配做准备。

访问堆上的数据相比访问栈上的数据慢，因为必须通过指针访问，而现代处理器的缓存机制使得读取连续内存区域比随机读取要快。

|              | 栈   | 堆     |
| ------------ | ---- | ------ |
| 存储数据大小 | 固定 | 不固定 |
| 分配数据     | 快   | 慢     |
| 访问数据     | 快   | 慢     | 

当代码调用一个函数时，传递给函数的值和函数的局部变量会被入栈。在函数结束后，这些值被移出栈中。

