# 设置线程池的大小
#Java #Multithreading 

线程池的理想大小取决于被提交任务的类型以及所属系统的特性。在代码中通常不会固定的线程池大小，而应该通过某种配置机制来提供，或者根据 Runtime.availableProcessors 来动态计算。

不正确配置的线程池带来的负面影响：

1. 线程池过大时，大量线程在相对很少的 CPU 和内存资源上发生竞争，导致更高的内存使用量，而且可能耗尽资源。
2. 线程池过小时，将导致许多空闲的处理器无法执行工作，从而降低吞吐率。

想要正确地设置线程池的大小，必须分析计算环境、资源预算和任务的特性。如果不同类型的任务在执行时行为相差很大，那么应该考虑多个线程池，从而使每个线程池可以根据各自的工作负载进行调整。

对于计算密集型任务，在拥有 $N_{cpu}$ 个处理器的系统上，线程池的大小为 $N_{cpu}+1$ 时，通常可以实现最优的利用率。[^1]

[^1]: 即使当计算密集型的线程偶尔由于页缺失故障或其他原因而暂停时，这个“额外”的线程也能确保 CPU 的时钟周期不会被浪费。

对于 I/O 密集型任务，线程可能由于阻塞操作并不会一直执行，因此线程池的规模可以更大。要正确设置线程池的大小，你必须估算出任务的等待时间与计算时间的比值。估算不需要很精确，并且可以通过一些分析工具或监控工具来获取。还可以通过另一种方法来调节线程池的大小：在某个基准负载下，分别设置不同大小的线程池来运行应用程序，并观察 CPU 利用率的水平。

定义如下：

+ $N_{cpu}$ 为 CPU 核心数。
+ $U_{cpu}$ 为目标 CPU 利用率，且 $0 \le U_{cpu} \le 1$。
+ $\frac W C$ 为任务等待时间与计算时间比值。

要使处理器达到期望的使用率，线程池的最优大小等于：$N_{threads}=N_{cpu}*U_{cpu}*(1+{\frac W C})$。

CPU 核心数可通过 Runtime 来获取：

```java
int cpus = Runtime.getRuntime().availableProcessors();
```

当然，CPU周期也不是唯一影响线程池大小的资源，另外还包括内存、文件句柄、套接字句柄和数据库连接等。而计算这些额外资源对线程池的约束条件也是更容易的：计算每个任务对该资源的需求量，然后用该资源的可用总量除以每个任务的需求量，所得就是线程池大小的上限。

