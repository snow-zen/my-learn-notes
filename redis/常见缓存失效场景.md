# 常见缓存失效场景
#Redis 

## 缓存雪崩

大量缓存在同一时间同时过期，导致处理大部分请求时需要去数据库查询数据。当请求过多时，可能会把数据库压垮。

对于热点数据可以不设置过期时间，永久有效。而对于普通缓存，可以在设置过期时间时可额外一些随机时间，防止出现同一时刻大面积缓存失效的情况。

## 缓存穿透

存在特殊请求总是请求一个不存在的数据，导致程序总是从 DB 中查询数据。当这种特殊请求过多时，会给 DB 产生很大的压力，从而影响正常服务。

当数据库中全量数据不多时，可以通过一个布隆过滤器来进行过滤。当请求记录 id 不存在布隆过滤器时，则无需查询数据库直接返回。如果以 Redis 的字符串制作的布隆过滤器，最大可支持 $2^{32}-1$ 条数据。

也可以给查询为空的数据在缓存中存入一个特殊的“空值”，之后的查询则直接使用缓存中获取到的空值。但使用空值需要注意以下两点：

1. 在新增记录时，需要删除缓存中对应的数据。防止之前请求的空值与数据库数据出现不一致的情况。
2. 设置空值的键需要指定过期时间，防止过多的空值键浪费内存空间。

## 缓存击穿

单一热点数据过期导致在处理请求时需要去数据库加载数据。当处于高并发的场景下，可能会把 DB 压垮。

同样可以对热点数据永久缓存，不设置过期时间。或者当发现缓存失效时，通过获取分布锁的方式来访问数据：

1. 获取缓存，发现缓存失效。
2. 尝试获取分布式锁。
	+ 锁获取成功时，从数据库查询数据后写入缓存中，并返回结果。
	+ 锁获取失败时，可尝试等待一段时间后，重新执行步骤 1。