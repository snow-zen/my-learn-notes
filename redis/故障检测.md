# 故障检测
#Redis 

Redis 集群的故障检测用于识别大多数节点何时不再可以访问主节点或副本节点，然后通过将副本节点提升为主节点来做出响应。

心跳包中每个都有一个与其他已知节点关联的标志列表。有两个用于故障检测的标志，称为 `PFAIL` 和 `FAIL`。`PFAIL` 表示可能的失败，未确认的失败类型。`FAIL` 表示节点出现故障，并且在固定时间内得到大多数节点的支持。

## PFAIL 标志

在心跳检测时，如果接收节点超过 `NODE_TIMEOUT` 没有做出响应，则发送节点会将接受节点标记为 `PFAIL` 状态。

## FAIL 标志

单独的 PFAIL 标志只是节点对其他节点的本地信息，或者说是主观认识，因此不足以触发副本提升。

通过[[容错|心跳检测]]中可以在 gossip 部分携带关于其他节点信息这一机制，每一个节点都可以向其他节点发送关于他们检测的故障情况状态。当满足以下一组条件时，`PFAIL` 标志将升级为 `FAIL` 标志：

+ 节点 A 中关于节点 B 的标志为 PFAIL。
+ 节点 A 通过 gossip 部分从集群中大多数主节点中收集到关于 B 的标志信息。
+ 在 `NODE_TIMEOUT * FAIL_REPORT_VALIDITY_MULT` 时间内大多数主节点发出 `PFAIL` 和 `FAIL` 信号。

> FAIL_REPORT_VALIDITY_MULT 默认实现为 2，所以是 NODE_TIMEOUT 时间的两倍。

当以上所有条件都满足时，节点 A 将执行以下操作：

+ 将节点 B 标记为 `FAIL`。
+ 向所有可达节点发送 `FAIL` 信息（通过 pong 包）。

该 `FAIL` 消息将强制所有接收到的节点将节点标记为 `FAIL` 状态，无论它原先的状态是否 `PFAIL`。[^1]被标记为 `FAIL` 状态后只有在以下情况可清除状态：

[^1]: 标记为 FAIL 状态后强制推送所有节点，可以保证如果集群处于错误状态时，通常所有节点会在同一时间停止接受写入。

+ 节点可重新访问，并且节点是个副本，因为它无需故障转移。
+ 节点可重新访问，并且节点是未分配任何哈希槽的主节点，因为没有哈希槽的节点并没有真正加入集群。
+ 节点可重新访问，并且节点是主节点，但是很长一段时间[^2]过去后，没有可检测的副本提升。这种情况可重新加入集群继续。

[^2]: 时间大致为 N * NODE_TIMEOUT。

Redis 集群故障检测有一个活跃性要求：最终所有节点都应该就给定节点的状态达成一致。FAIL 标志仅用作触发器，以运行副本提升算法的安全部分，避免由于本地问题而无法连接其主节点的副本发起错误的选举尝试。

