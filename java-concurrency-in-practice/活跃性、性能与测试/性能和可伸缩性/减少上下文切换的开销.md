# 减少上下文切换的开销
#Java #Multithreading 

许多任务中可能包含一些被阻塞的操作。每当任务在运行和阻塞状态之间进行切换，这相当于一次上下文切换。我们可以通过减少上下文切换来程序的吞吐量。此次将两种日志方式的调度行为进行分析。

大多数对 println 进行简单包装的日志框架中，会有一个专门的后台线程进行日志的打印。日志操作的服务时间包括：

1. 与 I/O 流类相关的计算时间。
2. 如果 I/O 操作被阻塞，则需包含被阻塞的时间。
3. I/O 操作结束时，可能其他线程正在执行它们的调度时间片，并且调度队列中有些线程在被阻塞线程前，进一步增加服务时间。

当多个线程都记录日志，则可能在输出流上发生锁竞争，线程被阻塞并等待锁，被线程调度器交换出去。如果有个线程由于 I/O 操作被阻塞，同时还持有一个锁，那么在这期间很可能会有另一个线程想要获得这个锁。这代码中的造成的上下文切换次数就会越多，吞吐量就越低。

可以通过消息队列的方式来分离处理请求的线程，线程记录日志时只需 put 日志到消息队列中，相比于 I/O 操作是一种更为轻量级的操作，因此在实际使用中发生阻塞的概率更小。