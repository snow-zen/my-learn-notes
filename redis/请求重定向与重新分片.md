# 请求重定向与重新分片
#Redis 

客户端可以自由地向集群中每个节点发送查询，包括副本节点。节点将分析查询键对应哈希槽所在的节点，并将其重定向到目标节点。

即使客户端在收到重定向到请求目标节点之间等待很长时间，并且在此期间集群配置发生变化，则重定向情况会再次发生，并不会有什么影响。

> 即使客户端所连接的实例没有及时更新最新的节点消息，给出的节点是错误的，也并不会有太大的影响。

重定向一般发生在集群不稳定时，但是经过一段时间过后所有集群节点都收到了正确的节点消息，所有的客户端都获得了正确哈希槽到节点之间的映射，则客户端无需重定向直接连接到正确的节点，从而使集群高效。

## 实时重新分片

集群支持在运行时重新分片，讲哈希槽从一个节点移动到另一个节点。从实际的角度看，哈希槽只是一组键，所以集群在重新分片过程中真正做的是将键从一个实例移动到另一个实例。

> 移动一个哈希槽，意味着将所有 hash 到这个散列值的键进行移动。

在哈希槽分配时，可以将哈希槽设置为 `MIGRATING` 和 `IMPORTING` 节点。这两个特殊状态用于将哈希槽从一个节点迁移到另一个节点。

当哈希槽被设置为 `MIGRATING` 时，如果该槽存在当前节点时，将接受该槽的所有查询，否则使用 `-ASK` 重定向将查询转发到迁移目标节点。

当哈希槽被设置为 `IMPORTING` 时，只有当客户端请求是 `-ASK` 重定向时，节点才会接受该槽的所有查询，否则通过 `-MOVED` 重定向到该槽的持有节点。

集群通过 MIGRATE 命令进行迁移：

1. 该命令将以原子方式将指定键从源节点迁移到目标节点。
2. MIGRATE 命令在将槽中的键发送到目标节点并收到 OK 代码后，删除自身数据集中旧键。

迁移过程中两个节点都在所需的时间内锁定，因此不存在竞争条件。从外部客户端的角度说，键在任何时间都存在于源节点或者目标节点。

当迁移完成时，可通过 `SETSLOT <slot> NODE <node-id>` 被发送到迁移所涉及的两个节点，用于将槽设置为正常状态。

## 临时重定向与永久重定向

在使用 `ASK` 重定向时，这只是一次临时的重定向。下次客户端访问相同哈希槽时还是会请求旧节点。而使用 `MOVED` 重定向则是永久的，客户端可以记住或更新哈希槽与新节点之间的映射关系，下次则直接请求新节点。

`ASK` 重定向的意义：该重定向一般在重新分片时被使用，因为此时集群是不稳定的，这次请求可能重定向到目标节点，但下次请求可能键还是在源节点。